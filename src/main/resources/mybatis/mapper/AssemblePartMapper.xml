<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.tcb.dao.IAssemblePartDao" >

    <resultMap id="assemblePartPojoResultMap" type="com.tcb.pojo.AssemblePartPojo">
        <id column="part_id" property="partId" jdbcType="BIGINT" />
        <result column="part_no" property="partNo" jdbcType="VARCHAR"/>
        <result column="part_memo" property="partMemo" jdbcType="VARCHAR"/>
        <result column="opt_user_id" property="optUserId" jdbcType="INTEGER"/>
        <result column="opt_user_name" property="optUserName" jdbcType="VARCHAR"/>
        <result column="opt_time" property="optTime" jdbcType="TIMESTAMP"/>
        <association property="assemblePojo" column="assemble_id" javaType="com.tcb.pojo.AssemblePojo"
                     resultMap="com.tcb.dao.IAssembleDao.assemblePojoResultMap"></association>
        <association property="partType" column="part_type" javaType="com.tcb.pojo.ParamPojo"
                     resultMap="com.tcb.dao.IParamDao.paramPojoResultMap"></association>
    </resultMap>

    <!-- 查询组装部件信息个数 -->
    <select id="getAssemblePartCount" resultType="java.lang.Integer">
        SELECT COUNT(DISTINCT tsap.part_id)
        FROM tbl_sys_assemble_part tsap
        INNER JOIN tbl_sys_assemble tsa ON tsap.assemble_id = tsa.assemble_id
        INNER JOIN tbl_sys_param tsp ON tsap.part_type = tsp.param_code
        LEFT JOIN tbl_sys_user tsu ON tsap.opt_user = tsu.user_id
        <where>
            <if test="assemblePartPojo != null and assemblePartPojo.assemblePojo != null
            and assemblePartPojo.assemblePojo.assembleId != null and assemblePartPojo.assemblePojo.assembleId>0">
                tsap.assemble_id = #{assemblePartPojo.assemblePojo.assembleId}
            </if>
            <if test="assemblePartPojo != null and assemblePartPojo.partNo != null and assemblePartPojo.partNo != ''">
                AND tsap.part_no LIKE CONCAT('%',CONCAT(#{assemblePartPojo.partNo},'%'))
            </if>
        </where>
    </select>

    <!-- 查询组装部件信息 -->
    <select id="getAssemblePart" resultMap="assemblePartPojoResultMap">
        SELECT DISTINCT
            tsap.part_id,
            tsa.assemble_id,
            tsa.pn_code,
            tsa.sn_code,
            tsa.job_no,
            tsp.param_code,
            tsp.param_name,
            tsap.part_no,
            tsap.part_memo,
            tsap.opt_user AS opt_user_id,
            tsu.user_name AS opt_user_name,
            tsap.opt_time
        FROM tbl_sys_assemble_part tsap
        INNER JOIN tbl_sys_assemble tsa ON tsap.assemble_id = tsa.assemble_id
        INNER JOIN tbl_sys_param tsp ON tsap.part_type = tsp.param_code
        LEFT JOIN tbl_sys_user tsu ON tsap.opt_user = tsu.user_id
        <where>
            <if test="assemblePartPojo != null and assemblePartPojo.assemblePojo != null
            and assemblePartPojo.assemblePojo.assembleId != null and assemblePartPojo.assemblePojo.assembleId>0">
                tsap.assemble_id = #{assemblePartPojo.assemblePojo.assembleId}
            </if>
            <if test="assemblePartPojo != null and assemblePartPojo.partNo != null and assemblePartPojo.partNo != ''">
                AND tsap.part_no LIKE CONCAT('%',CONCAT(#{assemblePartPojo.partNo},'%'))
            </if>
        </where>
        <if test="assemblePartPojo.rowIndex != null and assemblePartPojo.rowIndex >=0
            and assemblePartPojo.rowCount != null and assemblePartPojo.rowCount>0">
            LIMIT #{assemblePartPojo.rowIndex},#{assemblePartPojo.rowCount}
        </if>
    </select>

    <!-- 查询组装部信息(根据组装Id) -->
    <select id="getPartsByAssembleId" resultMap="assemblePartPojoResultMap">
        SELECT DISTINCT
            tsap.part_id,
            tsa.assemble_id,
            tsa.pn_code,
            tsa.sn_code,
            tsa.job_no,
            tsp.param_code,
            tsp.param_name,
            tsap.part_no,
            tsap.part_memo,
            tsap.opt_user AS opt_user_id,
            tsu.user_name AS opt_user_name,
            tsap.opt_time
        FROM tbl_sys_assemble_part tsap
        INNER JOIN tbl_sys_assemble tsa ON tsap.assemble_id = tsa.assemble_id
        INNER JOIN tbl_sys_param tsp ON tsap.part_type = tsp.param_code
        LEFT JOIN tbl_sys_user tsu ON tsap.opt_user = tsu.user_id
        WHERE tsap.assemble_id = #{assembleId}
    </select>
    
    <!-- 新增组装部件信息 -->
    <insert id="insertAssemblePart" parameterType="java.util.List">
        INSERT INTO tbl_sys_assemble_part(
            assemble_id,
            part_type,
            part_no,
            part_memo,
            opt_user
        )VALUES
        <foreach collection="assemblePartPojoList" item="item" index="index" separator=",">
            (
            #{item.assemblePojo.assembleId},
            #{item.partType.paramCode},
            #{item.partNo},
            #{item.partMemo},
            #{item.optUserId}
            )
        </foreach>
    </insert>

    <!-- 更新组装部件信息 -->
    <update id="updateAssemblePart" parameterType="java.util.List">
        UPDATE tbl_sys_assemble_part
        <trim prefix="set" suffixOverrides=",">
            <trim prefix="part_type = case " suffix="end,">
                <foreach collection="assemblePartPojoList" item="item" index="index">
                    when part_id=#{item.partId} then #{item.assemblePojo.assembleId}
                </foreach>
            </trim>
            <trim prefix="part_type = case " suffix="end,">
                <foreach collection="assemblePartPojoList" item="item" index="index">
                    when part_id=#{item.partId} then #{item.partType.paramCode}
                </foreach>
            </trim>
            <trim prefix="part_no = case " suffix="end,">
                <foreach collection="assemblePartPojoList" item="item" index="index">
                    when part_id=#{item.partId} then #{item.partNo}
                </foreach>
            </trim>
            <trim prefix="part_memo = case " suffix="end,">
                <foreach collection="assemblePartPojoList" item="item" index="index">
                    when part_id=#{item.partId} then #{item.partMemo}
                </foreach>
            </trim>
        </trim>
        WHERE part_id in
        <foreach collection="assemblePartPojoList" index="index" item="item" separator="," open="(" close=")">
            #{item.partId,jdbcType=BIGINT}
        </foreach>
    </update>

    <!-- 删除组装部件信息 -->
    <delete id="deleteAssemblePart" parameterType="java.util.List">
        DELETE FROM tbl_sys_assemble_part
        WHERE assemble_id = #{assembleId}
        <if test="idList != null and idList.size()>0">
            AND part_id IN
            <foreach collection="idList" item="item" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
    </delete>

</mapper>